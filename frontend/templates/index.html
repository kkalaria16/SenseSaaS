<!DOCTYPE html>
<html lang="en" class="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQL Agent | Premium Chat</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        brand: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            200: '#bfdbfe',
                            300: '#93c5fd',
                            400: '#60a5fa',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            800: '#1e40af',
                            900: '#1e3a8a',
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out forwards',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .dark ::-webkit-scrollbar-thumb {
            background: #475569;
        }

        .dark ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }

        /* --- MARKDOWN TYPOGRAPHY RESTORATION --- */
        .prose {
            font-size: 0.95rem;
            line-height: 1.6;
        }

        .prose p {
            margin-bottom: 1em;
        }

        .prose p:last-child {
            margin-bottom: 0;
        }

        /* Lists */
        .prose ul {
            list-style-type: disc;
            padding-left: 1.5em;
            margin-bottom: 1em;
        }

        .prose ol {
            list-style-type: decimal;
            padding-left: 1.5em;
            margin-bottom: 1em;
        }

        .prose li {
            margin-bottom: 0.3em;
        }

        /* Headings */
        .prose h1,
        .prose h2,
        .prose h3 {
            font-weight: 700;
            margin-top: 1.2em;
            margin-bottom: 0.5em;
            line-height: 1.3;
        }

        .prose h1 {
            font-size: 1.5em;
        }

        .prose h2 {
            font-size: 1.25em;
        }

        /* Links */
        .prose a {
            color: #2563eb;
            text-decoration: underline;
            font-weight: 500;
        }

        .dark .prose a {
            color: #60a5fa;
        }

        /* Code */
        .prose pre {
            background-color: #0f172a;
            color: #e2e8f0;
            padding: 1em;
            border-radius: 0.75em;
            overflow-x: auto;
            margin: 1em 0;
            border: 1px solid #334155;
            font-size: 0.85em;
        }

        .dark .prose pre {
            background-color: #020617;
            border-color: #1e293b;
        }

        .prose code {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85em;
            padding: 0.2em 0.4em;
            background: rgba(0, 0, 0, 0.06);
            border-radius: 4px;
            color: #db2777;
            font-weight: 500;
        }

        .dark .prose code {
            background: rgba(255, 255, 255, 0.1);
            color: #f472b6;
        }

        .prose pre code {
            background: transparent;
            padding: 0;
            color: inherit;
            font-weight: normal;
        }

        /* Tables */
        .prose table {
            width: 100%;
            border-collapse: collapse;
            margin: 1em 0;
            font-size: 0.9em;
        }

        .prose th {
            background: #f8fafc;
            font-weight: 600;
            text-align: left;
            padding: 0.75rem;
            border: 1px solid #e2e8f0;
        }

        .prose td {
            padding: 0.75rem;
            border: 1px solid #e2e8f0;
        }

        .dark .prose th {
            background: #1e293b;
            border-color: #334155;
        }

        .dark .prose td {
            border-color: #334155;
        }

        /* User Bubble Overrides (White Text) */
        .user-content .prose {
            color: white;
        }

        .user-content .prose strong {
            color: white;
        }

        .user-content .prose a {
            color: white;
        }

        .user-content .prose code {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        /* Assistant Bubble Colors */
        .prose strong {
            color: #0f172a;
        }

        .dark .prose strong {
            color: #f1f5f9;
        }

        .dark .prose {
            color: #e2e8f0;
        }

        /* Utilities */
        .bg-grid-pattern {
            background-image: linear-gradient(to right, #f1f5f9 1px, transparent 1px),
                linear-gradient(to bottom, #f1f5f9 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .dark .bg-grid-pattern {
            background-image: linear-gradient(to right, #1e293b 1px, transparent 1px),
                linear-gradient(to bottom, #1e293b 1px, transparent 1px);
        }

        .typing-dot {
            animation: typing 1.4s infinite ease-in-out both;
        }

        .typing-dot:nth-child(1) {
            animation-delay: -0.32s;
        }

        .typing-dot:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes typing {

            0%,
            80%,
            100% {
                transform: scale(0);
            }

            40% {
                transform: scale(1);
            }
        }
    </style>
</head>

<body
    class="bg-slate-50 dark:bg-slate-900 h-screen flex overflow-hidden text-slate-800 dark:text-slate-200 font-sans transition-colors duration-200">

    <div id="mobile-overlay"
        class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-40 hidden transition-opacity opacity-0"
        onclick="toggleSidebar()"></div>

    <aside id="sidebar"
        class="fixed inset-y-0 left-0 w-72 bg-white dark:bg-slate-800 border-r border-slate-200 dark:border-slate-700 z-50 transform -translate-x-full md:translate-x-0 transition-transform duration-300 flex flex-col shadow-2xl md:shadow-none">

        <div class="p-6 border-b border-slate-100 dark:border-slate-700">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div
                        class="w-10 h-10 rounded-xl bg-gradient-to-br from-brand-600 to-brand-700 flex items-center justify-center shadow-lg shadow-brand-500/20 text-white">
                        <i class="fas fa-database text-lg"></i>
                    </div>
                    <div>
                        <h1 class="font-bold text-lg tracking-tight text-slate-900 dark:text-white">SQL Agent</h1>
                        <div class="flex items-center gap-1.5">
                            <span class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></span>
                            <p class="text-xs text-slate-500 dark:text-slate-400 font-medium">System Online</p>
                        </div>
                    </div>
                </div>
                <button class="md:hidden text-slate-400 hover:text-slate-600 dark:hover:text-slate-200"
                    onclick="toggleSidebar()">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
        </div>

        <nav class="p-4 space-y-1 overflow-y-auto flex-1 custom-scrollbar">
            <button onclick="toggleDarkMode()"
                class="w-full flex items-center justify-between px-4 py-3 mb-6 text-sm font-medium text-slate-600 dark:text-slate-300 bg-slate-50 dark:bg-slate-700/50 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors border border-slate-100 dark:border-slate-600">
                <span class="flex items-center gap-3">
                    <i class="fas fa-moon dark:hidden"></i>
                    <i class="fas fa-sun hidden dark:inline text-amber-400"></i>
                    <span id="theme-text">Dark Mode</span>
                </span>
                <div class="w-8 h-4 bg-slate-300 dark:bg-brand-600 rounded-full relative transition-colors">
                    <div
                        class="w-4 h-4 bg-white rounded-full shadow-sm absolute top-0 left-0 dark:left-4 transition-all">
                    </div>
                </div>
            </button>

            <!-- <div class="px-3 mb-2 text-xs font-semibold text-slate-400 uppercase tracking-wider">Menu</div> -->

            <a href="/"
                class="flex items-center gap-3 px-4 py-3 text-sm font-medium text-brand-700 dark:text-brand-400 bg-brand-50 dark:bg-brand-900/20 rounded-xl border border-brand-100 dark:border-brand-900/30">
                <i class="fas fa-comments w-5 text-center"></i> Chat Interface
            </a>
            <a href="/charts"
                class="flex items-center gap-3 px-4 py-3 text-sm font-medium text-slate-600 dark:text-slate-400 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-colors">
                <i class="fas fa-chart-pie w-5 text-center"></i> Analytics
            </a>
            <a href="/logs"
                class="flex items-center gap-3 px-4 py-3 text-sm font-medium text-slate-600 dark:text-slate-400 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-colors">
                <i class="fas fa-list-ul w-5 text-center"></i> Audit Logs
            </a>

            <div class="mt-8 px-3 mb-2 text-xs font-semibold text-slate-400 uppercase tracking-wider">Context Settings
            </div>

            <div class="px-1">
                <div
                    class="bg-slate-50 dark:bg-slate-700/30 p-3 rounded-xl border border-slate-200 dark:border-slate-700 group focus-within:ring-2 focus-within:ring-brand-500/50 transition-colors">
                    <label class="block text-xs font-medium text-slate-500 dark:text-slate-400 mb-1.5">Company
                        ID</label>
                    <div class="relative">
                        <div
                            class="absolute inset-y-0 left-0 pl-2.5 flex items-center pointer-events-none text-slate-400">
                            <i class="fas fa-building text-xs"></i>
                        </div>
                        <input type="number" id="company-id" value="1" min="1"
                            class="block w-full pl-8 pr-3 py-1.5 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-lg text-sm dark:text-white focus:outline-none transition-all shadow-sm"
                            placeholder="ID">
                    </div>
                </div>
            </div>

            <div class="mt-4 px-1">
                <div
                    class="bg-slate-50 dark:bg-slate-700/30 p-3 rounded-xl border border-slate-200 dark:border-slate-700 focus-within:ring-2 focus-within:ring-brand-500/50 transition-colors">
                    <label class="block text-xs font-medium text-slate-500 dark:text-slate-400 mb-1.5">API
                        Configuration</label>
                    <input type="password" id="api-key"
                        class="w-full bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-lg px-3 py-2 text-xs dark:text-white focus:outline-none transition-all shadow-sm"
                        placeholder="Enter API Key..." value="your-secure-api-key-here">
                </div>
            </div>
        </nav>

        <div class="p-4 border-t border-slate-100 dark:border-slate-700 bg-slate-50 dark:bg-slate-800/50">
            <button onclick="location.reload()"
                class="w-full flex items-center justify-center gap-2 px-4 py-2.5 text-xs font-medium text-slate-600 dark:text-slate-300 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg hover:border-brand-300 hover:text-brand-600 dark:hover:text-brand-400 transition-all shadow-sm active:scale-95">
                <i class="fas fa-redo-alt"></i> Reset Session
            </button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col relative min-w-0 md:ml-72 h-full bg-grid-pattern transition-colors duration-200">

        <header
            class="md:hidden h-16 bg-white/80 dark:bg-slate-900/80 backdrop-blur border-b border-slate-200 dark:border-slate-800 flex items-center justify-between px-4 z-30 sticky top-0 shrink-0">
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 rounded-lg bg-brand-600 flex items-center justify-center text-white">
                    <i class="fas fa-database text-sm"></i>
                </div>
                <span class="font-bold text-slate-800 dark:text-white">SQL Agent</span>
            </div>
            <button onclick="toggleSidebar()"
                class="text-slate-500 dark:text-slate-400 hover:text-brand-600 p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors">
                <i class="fas fa-bars text-xl"></i>
            </button>
        </header>

        <div id="chat-scroller" class="flex-1 overflow-y-auto scroll-smooth min-h-0">

            <div id="chat-content" class="p-4 md:p-10 space-y-8 pb-32 md:pb-48">

                <div class="flex flex-col items-center justify-center min-h-[60vh] text-center space-y-8 animate-fade-in"
                    id="welcome-screen">
                    <div class="relative">
                        <div
                            class="absolute -inset-1 bg-gradient-to-r from-brand-400 to-purple-400 rounded-full blur opacity-25">
                        </div>
                        <div
                            class="w-24 h-24 bg-white dark:bg-slate-800 rounded-3xl flex items-center justify-center relative shadow-xl ring-1 ring-slate-100 dark:ring-slate-700">
                            <i class="fas fa-magic text-4xl text-brand-500"></i>
                        </div>
                    </div>

                    <div class="max-w-md space-y-3">
                        <h2 class="text-3xl font-bold text-slate-900 dark:text-white tracking-tight">How can I help you?
                        </h2>
                        <p class="text-slate-500 dark:text-slate-400 text-lg leading-relaxed">Ask questions about your
                            data in plain English. I'll write the SQL and show you the results.</p>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 w-full max-w-xl text-left">
                        <button
                            class="p-5 rounded-2xl border border-slate-200 dark:border-slate-700 bg-white/50 dark:bg-slate-800/50 hover:bg-white dark:hover:bg-slate-800 hover:border-brand-300 dark:hover:border-brand-500 hover:shadow-lg transition-all group"
                            onclick="useSuggestion('Show me all active jobs')">
                            <div class="flex justify-between items-start mb-1">
                                <span
                                    class="text-brand-600 dark:text-brand-400 bg-brand-50 dark:bg-brand-900/30 p-1.5 rounded-lg text-xs"><i
                                        class="fas fa-list"></i> List</span>
                                <i
                                    class="fas fa-arrow-right text-slate-300 group-hover:text-brand-400 opacity-0 group-hover:opacity-100 transition-all"></i>
                            </div>
                            <span class="block font-semibold text-slate-700 dark:text-slate-200">Show me active
                                jobs</span>
                        </button>

                        <button
                            class="p-5 rounded-2xl border border-slate-200 dark:border-slate-700 bg-white/50 dark:bg-slate-800/50 hover:bg-white dark:hover:bg-slate-800 hover:border-brand-300 dark:hover:border-brand-500 hover:shadow-lg transition-all group"
                            onclick="useSuggestion('Count customers by region')">
                            <div class="flex justify-between items-start mb-1">
                                <span
                                    class="text-purple-600 dark:text-purple-400 bg-purple-50 dark:bg-purple-900/30 p-1.5 rounded-lg text-xs"><i
                                        class="fas fa-chart-bar"></i> Aggregate</span>
                                <i
                                    class="fas fa-arrow-right text-slate-300 group-hover:text-purple-400 opacity-0 group-hover:opacity-100 transition-all"></i>
                            </div>
                            <span class="block font-semibold text-slate-700 dark:text-slate-200">Count customers by
                                region</span>
                        </button>
                    </div>
                </div>

            </div>
        </div>

        <div
            class="absolute bottom-0 left-0 right-0 z-20 p-4 md:p-6 bg-gradient-to-t from-white via-white/95 to-transparent dark:from-slate-900 dark:via-slate-900/95 pointer-events-none">
            <div class="max-w-3xl mx-auto pointer-events-auto">
                <form id="chat-form" class="relative group shadow-2xl rounded-2xl">
                    <div
                        class="absolute inset-0 bg-gradient-to-r from-brand-500 to-purple-600 rounded-2xl blur opacity-10 group-hover:opacity-20 transition-opacity duration-500">
                    </div>
                    <div
                        class="relative flex items-end gap-2 bg-white dark:bg-slate-800 ring-1 ring-slate-200 dark:ring-slate-700 rounded-2xl p-2 pl-4 focus-within:ring-2 focus-within:ring-brand-500 transition-shadow">
                        <textarea id="user-input" rows="1" placeholder="Ask anything about your data..."
                            class="w-full py-3.5 bg-transparent border-none focus:ring-0 resize-none max-h-32 text-slate-700 dark:text-slate-100 placeholder-slate-400 text-base leading-relaxed"
                            oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'"
                            onkeydown="handleEnter(event)"></textarea>

                        <button type="submit" id="send-btn"
                            class="mb-1 p-3 rounded-xl bg-brand-600 hover:bg-brand-700 text-white active:scale-95 transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center w-11 h-11 shrink-0 shadow-lg shadow-brand-500/30">
                            <i class="fas fa-paper-plane text-sm"></i>
                        </button>
                    </div>
                </form>
                <p class="text-center text-xs text-slate-400 dark:text-slate-500 mt-3 font-medium">
                    <i class="fas fa-shield-alt mr-1"></i> Data is processed securely. AI results may vary.
                </p>
            </div>
        </div>
    </main>

    <script>
        // --- Dark Mode Logic ---
        function toggleDarkMode() {
            const html = document.documentElement;
            const isDark = html.classList.toggle('dark');
            const text = document.getElementById('theme-text');
            text.innerText = isDark ? 'Light Mode' : 'Dark Mode';
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        }

        if (localStorage.getItem('theme') === 'dark' ||
            (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
            document.getElementById('theme-text').innerText = 'Light Mode';
        }

        // --- Sidebar Logic ---
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobile-overlay');
            const isClosed = sidebar.classList.contains('-translate-x-full');

            if (isClosed) {
                sidebar.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
                setTimeout(() => overlay.classList.remove('opacity-0'), 10);
            } else {
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('opacity-0');
                setTimeout(() => overlay.classList.add('hidden'), 300);
            }
        }

        // --- Chat Logic ---
        const chatForm = document.getElementById('chat-form');
        const userInput = document.getElementById('user-input');
        const chatScroller = document.getElementById('chat-scroller'); // The scrollable container
        const chatContent = document.getElementById('chat-content'); // The inner wrapper
        const welcomeScreen = document.getElementById('welcome-screen');
        const sendBtn = document.getElementById('send-btn');
        let isProcessing = false;

        let threadId = localStorage.getItem('chat_thread_id');
        if (!threadId) {
            threadId = 'user-' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('chat_thread_id', threadId);
        }

        window.handleEnter = function (e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                chatForm.dispatchEvent(new Event('submit'));
            }
        };

        window.useSuggestion = function (text) {
            userInput.value = text;
            userInput.style.height = 'auto';
            userInput.style.height = userInput.scrollHeight + 'px';
            chatForm.dispatchEvent(new Event('submit'));
        };

        function showTyping() {
            const id = 'typing-' + Date.now();
            const html = `
                <div id="${id}" class="flex gap-4 animate-fade-in mb-6">
                    <div class="w-8 h-8 rounded-full bg-white dark:bg-slate-700 border border-slate-100 dark:border-slate-600 flex items-center justify-center shrink-0 shadow-sm mt-1">
                        <i class="fas fa-robot text-brand-600 dark:text-brand-400 text-xs"></i>
                    </div>
                    <div class="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-2xl rounded-tl-none px-4 py-3 shadow-sm inline-flex items-center gap-2">
                        <div class="w-1.5 h-1.5 bg-slate-400 rounded-full animate-bounce" style="animation-delay: 0s"></div>
                        <div class="w-1.5 h-1.5 bg-slate-400 rounded-full animate-bounce" style="animation-delay: 0.15s"></div>
                        <div class="w-1.5 h-1.5 bg-slate-400 rounded-full animate-bounce" style="animation-delay: 0.3s"></div>
                    </div>
                </div>`;
            chatContent.insertAdjacentHTML('beforeend', html);
            scrollToBottom();
            return id;
        }

        function removeTyping(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }

        function scrollToBottom() {
            // Scroll the SCROLLER div, not the content
            chatScroller.scrollTo({ top: chatScroller.scrollHeight, behavior: 'smooth' });
        }

        function formatTableData(results) {
            if (!results || results.length === 0) return '';
            const headers = Object.keys(results[0]);

            let html = `
                <div class="w-full max-w-full overflow-hidden rounded-xl border border-slate-200 dark:border-slate-700 mt-4 shadow-sm bg-white dark:bg-slate-800">
                    <div class="overflow-x-auto custom-scrollbar">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-slate-50 dark:bg-slate-700/50 text-slate-500 dark:text-slate-400 uppercase text-xs font-semibold tracking-wider">
                                <tr>`;
            headers.forEach(h => html += `<th class="px-5 py-3 border-b border-slate-200 dark:border-slate-700 whitespace-nowrap">${h}</th>`);
            html += `       </tr></thead>
                            <tbody class="divide-y divide-slate-100 dark:divide-slate-700/50">`;

            results.forEach(row => {
                html += '<tr class="bg-white dark:bg-slate-800 hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-colors">';
                headers.forEach(h => html += `<td class="px-5 py-3 text-slate-700 dark:text-slate-300 whitespace-nowrap font-medium">${row[h] !== null ? row[h] : '<span class="text-slate-300">-</span>'}</td>`);
                html += '</tr>';
            });
            html += `</tbody></table></div></div>`;
            return html;
        }

        function addMessage(role, content, isError = false, sql = null, tableHtml = null) {
            if (welcomeScreen) welcomeScreen.style.display = 'none';
            const div = document.createElement('div');
            div.className = `flex gap-4 animate-fade-in w-full ${role === 'user' ? 'flex-row-reverse' : ''}`;

            const avatar = role === 'user'
                ? `<div class="w-9 h-9 rounded-full bg-brand-600 flex items-center justify-center shrink-0 shadow-md mt-1 border border-brand-500"><i class="fas fa-user text-white text-xs"></i></div>`
                : `<div class="w-9 h-9 rounded-full bg-white dark:bg-slate-700 flex items-center justify-center shrink-0 shadow-sm mt-1 border border-slate-200 dark:border-slate-600"><i class="fas fa-robot text-brand-600 dark:text-brand-400 text-xs"></i></div>`;

            const bubbleClass = role === 'user'
                ? 'bg-brand-600 text-white rounded-2xl rounded-tr-sm px-5 py-3.5 shadow-md max-w-full md:max-w-full user-content'
                : 'bg-white/20 dark:bg-slate-800/60 border border-white/100 dark:border-slate-700/70 rounded-2xl rounded-tl-none px-6 py-5 shadow-lg w-full max-w-full overflow-hidden backdrop-blur-md hover:bg-white/40 dark:hover:bg-slate-800/80 hover:backdrop-blur-xl hover:shadow-2xl hover:border-white/60 dark:hover:border-slate-700/90 transition-all duration-300 dark:hover:shadow-[0_0_20px_rgba(255,255,255,0.15)]';

            let formattedContent;
            if (typeof marked !== 'undefined' && role !== 'user') {
                marked.setOptions({ breaks: true });
                formattedContent = marked.parse(content);
            } else {
                formattedContent = content.replace(/\n/g, '<br>');
            }

            let innerHtml = `
                ${avatar}
                <div class="${role !== 'user' ? 'flex-1 min-w-0' : ''}"> 
                    <div class="${bubbleClass}">
                        <div class="prose max-w-none break-words leading-relaxed">
                            ${formattedContent}
                        </div>`;

            if (sql) {
                const sqlId = 'sql-' + Math.random().toString(36).substr(2, 9);
                innerHtml += `
                    <div class="mt-4 border-t border-slate-100 dark:border-slate-700 pt-3">
                        <button onclick="document.getElementById('${sqlId}').classList.toggle('hidden')" 
                            class="text-xs font-medium text-slate-500 dark:text-slate-400 hover:text-brand-600 dark:hover:text-brand-400 focus:outline-none flex items-center gap-1.5 transition-colors">
                            <i class="fas fa-code"></i> View Generated SQL
                        </button>
                        <div id="${sqlId}" class="hidden mt-2 bg-slate-900 rounded-xl p-4 relative group overflow-hidden border border-slate-700 shadow-inner">
                            <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                <button onclick="navigator.clipboard.writeText(this.nextElementSibling.innerText)"
                                    class="p-1.5 text-slate-400 hover:text-white rounded bg-slate-800 hover:bg-slate-700 transition-colors"><i class="fas fa-copy text-xs"></i></button>
                                <span class="hidden">${sql}</span>
                            </div>
                            <code class="text-xs font-mono text-emerald-400 block whitespace-pre-wrap break-all leading-5">${sql}</code>
                        </div>
                    </div>`;
            }

            if (tableHtml) innerHtml += tableHtml;
            if (isError) {
                innerHtml += `
                <div class="mt-3 bg-red-50 dark:bg-red-900/20 border border-red-100 dark:border-red-800 text-red-600 dark:text-red-400 rounded-lg p-3 text-sm flex items-start gap-2">
                    <i class="fas fa-exclamation-circle mt-0.5"></i>
                    <span>Error processing request. Please try again.</span>
                </div>`;
            }

            innerHtml += `</div></div>`;
            div.innerHTML = innerHtml;
            chatContent.appendChild(div);
            scrollToBottom();
        }

        // --- Event Listeners ---
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (isProcessing) return;
            const message = userInput.value.trim();
            if (!message) return;

            isProcessing = true;
            userInput.value = '';
            userInput.style.height = 'auto';
            userInput.disabled = true;
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            addMessage('user', message);
            const typingId = showTyping();

            try {
                const companyId = document.getElementById('company-id').value || '1';
                const apiKey = document.getElementById('api-key').value || '';

                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-API-Key': apiKey },
                    body: JSON.stringify({
                        message: message,
                        company_id: companyId,
                        thread_id: threadId,
                        chat_history: [],
                        max_iterations: 3
                    })
                });

                if (!response.ok) throw new Error('API Error');
                const data = await response.json();
                removeTyping(typingId);

                const content = data.natural_response || data.summary_text || data.message || 'Done.';
                const sql = data.sql || data.sql_query;
                const tableHtml = (data.results && data.results.length > 0) ? formatTableData(data.results) : null;

                if (data.is_clarification) {
                    addMessage('assistant', "ðŸ¤” **Clarification Needed:**\n\n" + content, false);
                } else {
                    addMessage('assistant', content, !!data.error, sql, tableHtml);
                }
            } catch (error) {
                console.error(error);
                removeTyping(typingId);
                addMessage('assistant', "Sorry, something went wrong processing your request.", true);
            } finally {
                isProcessing = false;
                userInput.disabled = false;
                sendBtn.disabled = false;
                sendBtn.innerHTML = '<i class="fas fa-paper-plane text-sm"></i>';
                userInput.focus();
            }
        });
    </script>
</body>

</html>