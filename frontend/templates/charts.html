<!DOCTYPE html>
<html lang="en" class="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics | SQL Agent</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        brand: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            200: '#bfdbfe',
                            300: '#93c5fd',
                            400: '#60a5fa',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            800: '#1e40af',
                            900: '#1e3a8a',
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.4s ease-out forwards',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        /* Subtle Grid Pattern */
        .bg-grid-pattern {
            background-image: linear-gradient(to right, #f8fafc 1px, transparent 1px),
                              linear-gradient(to bottom, #f8fafc 1px, transparent 1px);
            background-size: 20px 20px;
        }
        .dark .bg-grid-pattern {
            background-image: linear-gradient(to right, #1e293b 1px, transparent 1px),
                              linear-gradient(to bottom, #1e293b 1px, transparent 1px);
        }

        /* Card Styles */
        .dashboard-card {
            background-color: #ffffff;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03); 
            border-radius: 1rem;
        }
        .dark .dashboard-card {
            background-color: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: none;
        }

        /* Input Clean Up */
        .clean-input {
            border: 0;
            background: #f8fafc;
            box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.02);
        }
        .clean-input:focus {
            background: #ffffff;
            box-shadow: 0 0 0 2px #3b82f6, 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .dark .clean-input {
            background: rgba(15, 23, 42, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: none;
        }
        .dark .clean-input:focus {
            border-color: #3b82f6;
            background: rgba(15, 23, 42, 0.8);
        }
    </style>
</head>

<body class="bg-slate-50 dark:bg-slate-900 h-screen flex overflow-hidden text-slate-800 dark:text-slate-200 font-sans transition-colors duration-200">

    <div id="mobile-overlay" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-40 hidden transition-opacity opacity-0" onclick="toggleSidebar()"></div>

    <aside id="sidebar" class="fixed inset-y-0 left-0 w-72 bg-white dark:bg-slate-800 border-r-0 md:border-r border-slate-100 dark:border-slate-700/50 z-50 transform -translate-x-full md:translate-x-0 transition-transform duration-300 flex flex-col shadow-2xl md:shadow-none">
        <div class="p-6">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-brand-600 to-brand-700 flex items-center justify-center shadow-lg shadow-brand-500/20 text-white">
                    <i class="fas fa-database text-lg"></i>
                </div>
                <div>
                    <h1 class="font-bold text-lg tracking-tight text-slate-900 dark:text-white">SQL Agent</h1>
                    <div class="flex items-center gap-1.5">
                        <span class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></span>
                        <p class="text-xs text-slate-500 dark:text-slate-400 font-medium">System Online</p>
                    </div>
                </div>
                <button class="md:hidden ml-auto text-slate-400" onclick="toggleSidebar()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>

        <nav class="p-4 space-y-1 overflow-y-auto flex-1 custom-scrollbar">
            <button onclick="toggleDarkMode()" class="w-full flex items-center justify-between px-4 py-3 mb-6 text-sm font-medium text-slate-600 dark:text-slate-300 bg-slate-50 dark:bg-slate-700/30 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-700/50 transition-colors">
                <span class="flex items-center gap-3">
                    <i class="fas fa-moon dark:hidden"></i>
                    <i class="fas fa-sun hidden dark:inline text-amber-400"></i>
                    <span id="theme-text">Dark Mode</span>
                </span>
                <div class="w-8 h-4 bg-slate-200 dark:bg-brand-600 rounded-full relative transition-colors">
                    <div class="w-4 h-4 bg-white rounded-full shadow-sm absolute top-0 left-0 dark:left-4 transition-all"></div>
                </div>
            </button>

            <a href="/" class="flex items-center gap-3 px-4 py-3 text-sm font-medium text-slate-600 dark:text-slate-400 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700/30 transition-colors">
                <i class="fas fa-comments w-5 text-center"></i> Chat Interface
            </a>
            <a href="/charts" class="flex items-center gap-3 px-4 py-3 text-sm font-medium text-brand-700 dark:text-brand-400 bg-brand-50 dark:bg-brand-900/20 rounded-xl">
                <i class="fas fa-chart-pie w-5 text-center"></i> Analytics
            </a>
            <a href="/logs" class="flex items-center gap-3 px-4 py-3 text-sm font-medium text-slate-600 dark:text-slate-400 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700/30 transition-colors">
                <i class="fas fa-list-ul w-5 text-center"></i> Audit Logs
            </a>

            <div class="mt-8 px-3 mb-2 text-xs font-semibold text-slate-400 uppercase tracking-wider">Context Settings</div>
            <div class="px-1 space-y-4">
                <div class="bg-slate-50 dark:bg-slate-700/30 p-3 rounded-xl">
                    <label class="block text-xs font-medium text-slate-500 dark:text-slate-400 mb-1.5">Company ID</label>
                    <input type="number" id="companySelect" value="1" min="1" class="clean-input block w-full px-3 py-1.5 rounded-lg text-sm dark:text-white outline-none transition-all" placeholder="ID">
                </div>
                <div class="bg-slate-50 dark:bg-slate-700/30 p-3 rounded-xl">
                    <label class="block text-xs font-medium text-slate-500 dark:text-slate-400 mb-1.5">API Configuration</label>
                    <input type="password" id="apiKeyInput" class="clean-input w-full rounded-lg px-3 py-2 text-xs dark:text-white outline-none transition-all" placeholder="Enter API Key..." value="your-secure-api-key-here">
                </div>
            </div>
        </nav>
    </aside>

    <main class="flex-1 flex flex-col relative min-w-0 md:ml-72 h-full bg-grid-pattern transition-colors duration-200 overflow-y-auto">
        
        <header class="md:hidden h-16 bg-white/80 dark:bg-slate-900/80 backdrop-blur border-b border-slate-100 dark:border-slate-800 flex items-center justify-between px-4 sticky top-0 z-30">
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 rounded-lg bg-brand-600 flex items-center justify-center text-white">
                    <i class="fas fa-database text-sm"></i>
                </div>
                <span class="font-bold text-slate-800 dark:text-white">SQL Agent</span>
            </div>
            <button onclick="toggleSidebar()" class="text-slate-500 dark:text-slate-400 p-2">
                <i class="fas fa-bars text-xl"></i>
            </button>
        </header>

        <div class="p-6 md:p-12 max-w-7xl mx-auto w-full">
            
            <div class="mb-10 animate-fade-in">
                <h1 class="text-3xl font-bold text-slate-900 dark:text-white tracking-tight">AI Analytics</h1>
                <p class="text-slate-500 dark:text-slate-400 mt-2 text-lg">Visualize your database with natural language queries.</p>
            </div>

            <div class="dashboard-card p-2 mb-8 animate-fade-in relative group flex items-center">
                <div class="flex-1 relative">
                    <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                        <i class="fas fa-search text-slate-400"></i>
                    </div>
                    <input type="text" id="queryInput"
                        class="w-full bg-transparent border-none text-slate-800 dark:text-white text-base focus:ring-0 block w-full pl-11 p-4 placeholder:text-slate-400 outline-none"
                        placeholder="e.g., Show me job status distribution..." 
                        onkeydown="if(event.key === 'Enter') generateChart()">
                </div>
                <button onclick="generateChart()" id="generateBtn"
                    class="m-2 bg-brand-600 hover:bg-brand-700 text-white font-medium rounded-lg px-6 py-2.5 transition-all duration-200 shadow hover:shadow-lg flex items-center gap-2 shrink-0">
                    <span>Generate</span>
                </button>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 animate-fade-in" style="animation-delay: 0.1s">
                
                <div class="lg:col-span-2">
                    <div class="dashboard-card p-8 h-[600px] flex flex-col relative overflow-hidden">
                        <div class="flex justify-between items-center mb-6 z-10">
                            <h3 id="chartTitle" class="text-xl font-bold text-slate-800 dark:text-white">Chart Preview</h3>
                            <div class="flex gap-2 opacity-30">
                                <i class="fas fa-expand text-slate-400 cursor-pointer hover:text-brand-500 transition-colors"></i>
                            </div>
                        </div>
                        
                        <div id="chartContainer" class="flex-1 w-full h-full flex items-center justify-center rounded-xl bg-slate-50/50 dark:bg-slate-800/30 transition-all">
                            <div class="text-center text-slate-400 dark:text-slate-500">
                                <i class="fas fa-chart-bar text-4xl mb-3 opacity-30"></i>
                                <p class="text-sm font-medium opacity-60">Enter a query above to begin</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-1 space-y-6">
                    
                    <div class="dashboard-card p-6 flex flex-col">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-semibold text-slate-800 dark:text-white flex items-center gap-2">
                                <i class="fas fa-code text-brand-500"></i> SQL
                            </h3>
                            <button class="text-xs font-medium text-slate-400 hover:text-brand-600 transition-colors" onclick="navigator.clipboard.writeText(document.getElementById('sqlOutput').innerText)">
                                COPY
                            </button>
                        </div>
                        <div class="bg-slate-50 dark:bg-slate-900 rounded-lg p-4 overflow-x-auto border-0 flex-1 custom-scrollbar">
                            <pre><code id="sqlOutput" class="text-xs font-mono text-slate-600 dark:text-emerald-400 whitespace-pre-wrap">-- SQL query will appear here...</code></pre>
                        </div>
                    </div>

                    <div class="dashboard-card p-6">
                        <h3 class="font-semibold text-slate-800 dark:text-white mb-4 flex items-center gap-2">
                            <i class="fas fa-sliders-h text-purple-500"></i> Details
                        </h3>
                        <div id="configOutput" class="space-y-3">
                            <div class="flex justify-between items-center py-2 border-b border-slate-100 dark:border-slate-700/50 last:border-0">
                                <span class="text-xs text-slate-500 dark:text-slate-400 font-medium uppercase tracking-wide">Type</span>
                                <span class="text-sm text-slate-800 dark:text-slate-200 font-mono">-</span>
                            </div>
                            <div class="flex justify-between items-center py-2 border-b border-slate-100 dark:border-slate-700/50 last:border-0">
                                <span class="text-xs text-slate-500 dark:text-slate-400 font-medium uppercase tracking-wide">X-Axis</span>
                                <span class="text-sm text-slate-800 dark:text-slate-200 font-mono">-</span>
                            </div>
                            <div class="flex justify-between items-center py-2 border-b border-slate-100 dark:border-slate-700/50 last:border-0">
                                <span class="text-xs text-slate-500 dark:text-slate-400 font-medium uppercase tracking-wide">Y-Axis</span>
                                <span class="text-sm text-slate-800 dark:text-slate-200 font-mono">-</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // --- Sidebar & Theme Logic ---
        function toggleDarkMode() {
            const html = document.documentElement;
            const isDark = html.classList.toggle('dark');
            document.getElementById('theme-text').innerText = isDark ? 'Light Mode' : 'Dark Mode';
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            
            // Fix: Immediately update chart theme when toggling
            if (myChart) {
                updateChartTheme(isDark);
            }
        }

        function updateChartTheme(isDark) {
            const textColor = isDark ? '#94a3b8' : '#475569';
            const gridColor = isDark ? '#334155' : '#e2e8f0';
            const borderColor = isDark ? '#1e293b' : '#ffffff'; // Match card background

            const option = myChart.getOption();
            // ECharts doesn't make it easy to patch deep options without resetting, 
            // but we can set specific properties that affect colors.
            
            let newOptions = {
                legend: { textStyle: { color: textColor } },
            };

            // Check if Pie or Axis chart
            if (option.series && option.series[0] && option.series[0].type === 'pie') {
                 newOptions.series = [{
                    itemStyle: { 
                        borderColor: borderColor, 
                        borderWidth: 2 
                    },
                    emphasis: { label: { color: textColor } }
                 }];
            } else {
                newOptions.xAxis = {
                    axisLabel: { color: textColor },
                    axisLine: { lineStyle: { color: gridColor } }
                };
                newOptions.yAxis = {
                    axisLabel: { color: textColor },
                    splitLine: { lineStyle: { color: gridColor } }
                };
            }
            
            myChart.setOption(newOptions);
        }

        if (localStorage.getItem('theme') === 'dark' || (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
            document.getElementById('theme-text').innerText = 'Light Mode';
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobile-overlay');
            const isClosed = sidebar.classList.contains('-translate-x-full');
            if (isClosed) {
                sidebar.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
                setTimeout(() => overlay.classList.remove('opacity-0'), 10);
            } else {
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('opacity-0');
                setTimeout(() => overlay.classList.add('hidden'), 300);
            }
        }

        // --- Chart Logic ---
        let myChart = null;

        async function generateChart() {
            const query = document.getElementById('queryInput').value;
            const companyId = document.getElementById('companySelect').value;
            const apiKey = document.getElementById('apiKeyInput').value;
            const btn = document.getElementById('generateBtn');
            const container = document.getElementById('chartContainer');

            if (!query) return;

            btn.disabled = true;
            const originalBtnText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i>';

            try {
                const response = await fetch('/api/charts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-API-Key': apiKey },
                    body: JSON.stringify({ message: query, company_id: parseInt(companyId) })
                });

                const data = await response.json();

                if (data.error) {
                    alert('Error: ' + data.error);
                    return;
                }

                document.getElementById('sqlOutput').textContent = data.sql || '-- No SQL generated';

                const config = data.chart_config;
                document.getElementById('configOutput').innerHTML = `
                    <div class="flex justify-between items-center py-2 border-b border-slate-100 dark:border-slate-700/50 last:border-0">
                        <span class="text-xs text-slate-500 dark:text-slate-400 font-medium uppercase tracking-wide">Type</span>
                        <span class="text-sm font-bold text-slate-800 dark:text-white font-mono capitalize">${config.type}</span>
                    </div>
                    <div class="flex justify-between items-center py-2 border-b border-slate-100 dark:border-slate-700/50 last:border-0">
                        <span class="text-xs text-slate-500 dark:text-slate-400 font-medium uppercase tracking-wide">X-Axis</span>
                        <span class="text-sm text-slate-700 dark:text-slate-300 font-mono">${config.labels}</span>
                    </div>
                    <div class="flex justify-between items-center py-2 border-b border-slate-100 dark:border-slate-700/50 last:border-0">
                        <span class="text-xs text-slate-500 dark:text-slate-400 font-medium uppercase tracking-wide">Y-Axis</span>
                        <span class="text-sm text-slate-700 dark:text-slate-300 font-mono">${config.values}</span>
                    </div>
                `;
                document.getElementById('chartTitle').textContent = config.title;

                if (myChart) myChart.dispose();
                container.innerHTML = ''; 
                container.classList.remove('bg-slate-50/50', 'dark:bg-slate-800/30');

                const isDark = document.documentElement.classList.contains('dark');
                const textColor = isDark ? '#94a3b8' : '#475569'; 
                const gridColor = isDark ? '#334155' : '#e2e8f0';
                const borderColor = isDark ? '#1e293b' : '#ffffff';

                myChart = echarts.init(container);
                const labels = data.results.map(item => item[config.labels]);
                const values = data.results.map(item => item[config.values]);

                let option = {
                    backgroundColor: 'transparent',
                    textStyle: { fontFamily: 'Inter, sans-serif' }
                };

                if (config.type === 'pie') {
                    option = {
                        ...option,
                        tooltip: { trigger: 'item' },
                        legend: { top: '5%', left: 'center', textStyle: { color: textColor } },
                        series: [{
                            name: config.title,
                            type: 'pie',
                            radius: ['40%', '70%'],
                            itemStyle: { 
                                borderRadius: 8, 
                                borderColor: borderColor, 
                                borderWidth: 2 
                            },
                            label: { show: false, position: 'center' },
                            emphasis: { label: { show: true, fontSize: 18, fontWeight: 'bold', color: textColor } },
                            data: data.results.map(item => ({ value: item[config.values], name: item[config.labels] }))
                        }]
                    };
                } else {
                    option = {
                        ...option,
                        tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
                        grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
                        xAxis: { 
                            type: 'category', 
                            data: labels, 
                            axisLabel: { color: textColor, fontWeight: 500 },
                            axisLine: { lineStyle: { color: gridColor } }
                        },
                        yAxis: { 
                            type: 'value',
                            axisLabel: { color: textColor },
                            splitLine: { lineStyle: { color: gridColor, type: 'dashed' } }
                        },
                        series: [{
                            name: config.values,
                            type: config.type === 'line' ? 'line' : 'bar',
                            barWidth: '40%',
                            data: values,
                            smooth: true,
                            itemStyle: { color: '#3b82f6', borderRadius: [4, 4, 0, 0] },
                            areaStyle: config.type === 'line' ? {
                                color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                    { offset: 0, color: 'rgba(59,130,246,0.5)' },
                                    { offset: 1, color: 'rgba(59,130,246,0.0)' }
                                ])
                            } : null
                        }]
                    };
                }

                myChart.setOption(option);

            } catch (error) {
                console.error(error);
                alert('An error occurred.');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalBtnText;
            }
        }

        window.addEventListener('resize', function () {
            if (myChart) myChart.resize();
        });
    </script>
</body>
</html>